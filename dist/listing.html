<!doctype html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <title>View Listing</title>
  <!-- BootStrap CDN -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.2/dist/css/bootstrap.min.css" rel="stylesheet"
    integrity="sha384-Zenh87qX5JnK2Jl0vWa8Ck2rdkQ2Bzep5IDxbcnCeuOxjzrPF/et3URy9Bv1WTRi" crossorigin="anonymous">
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.2/dist/js/bootstrap.bundle.min.js"
    integrity="sha384-OERcA2EqjJCMA+/3y+gxIOqMEjwtxJY7qPCqsdltbNJuaOe923+mo//f6V8Qbsw3"
    crossorigin="anonymous"></script>
  <!-- CSS Stylesheet -->
  <link rel="stylesheet" href="styles.css">
  <!-- End Of Css Stylesheet -->

  <!-- This Link connects to freeawesome icons -->
  <script src="https://kit.fontawesome.com/01f542bdd3.js" crossorigin="anonymous"></script>

  <!-- Google Fonts stylesheet -->
  <!--This section allows to get font from GOOGLE Fonts - Namely Fredoka for headers and Raleway for paragraph-->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Fredoka:wght@500;600&family=Raleway&display=swap"
    rel="stylesheet">
  <!-- End Of Google Fonts Stylesheet -->

  <!-- script needed for map -->
  <script src="https://unpkg.com/leaflet@1.9.2/dist/leaflet.js"
    integrity="sha256-o9N1jGDZrf5tS+Ft4gbIK7mYMipq9lqpVJ91xHSyKhg=" crossorigin=""></script>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.2/dist/leaflet.css"
    integrity="sha256-sA+zWATbFveLLNqWO2gtiw3HL/lh1giY/Inf1BJ0z14=" crossorigin="" />
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
  <!-- end script needed for map -->

  <!-- Axios -->
  <script src="https://unpkg.com/axios@1.1.2/dist/axios.min.js"></script>

  <!-- Vue CDN -->
  <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>

  <style>
    .card {
      border:transparent;
    }

    .card-body{
      font-size: 80%
    }

    #referrer{
      box-shadow: 5px 5px 10px 2px rgba(0,0,0,.1);
    }
  </style>

</head>

<body>
  <div id="navbardiv" class="sticky-top">
    <navbar-all :userid="user_id" :username="username" v-on:log_out="logout"></navbar-all>
  </div>

  <!-- Start Of Body Content-->
  <div id="root" class="body-container mt-5" style="overflow-x:hidden;">

    <!-- Update Last Seen Location Pop Up Box (Hidden By Default) -->
    <form action="">
      <div class='update mt-5 mx-auto' id='update'>
        <h4 class="text-center mt-3" style="color: #FBE8A6;">Update Last Seen Location</h4>

        <!-- Integrate Map API here -->
        <div class='my-5' id="mapUpdate">
          <label for="map" class="form-label">Update Location</label>
        </div>

        <!-- Custom Notes -->
        <div class="mb-4">
          <label for="notes" class="form-label">Custom Notes</label>
          <textarea class="form-control" id="notes" rows="5" placeholder="Enter Notes here... "></textarea>
        </div>

        <div class="gap-2 d-flex justify-content-md-center mb-3 text-center">
          <button class="btn btn-releasepop mb-3" type="submit" name="submit">Update</button>
          <button class="btn btn-releasepop mb-3" type="submit" name="cancel" @click="closeUpdate()">Cancel</button>
        </div>
      </div>
    </form>


    <div id="main">
      <!-- Start of First Section-->
      <div class="container-fluid listing-container" id="main">

        <!-- Section for Listing Content -->
        <div class="listing">
          <div class="row">
            <div class="col my-4">

              <!-- Start Of Card -->
              <div class="card mb-3" style="border:transparent">
                <div class="row d-flex" style="align-items:center">
                  <div class="col-md-4">
                    <img src="./icons/colored_profile.png" class="img-fluid rounded-start;"
                      style="height: auto; width: auto;">
                  </div>

                  <div class="col-md-8">
                    <div class="card-body px-5">
                      <div class="row d-flex" style="align-items:center">
                        <h5 class="card-title">Referral: Jeff So</h5>
                        <p class="card-text my-1"><small class="text-muted">Status: Seeked Shelter</small></p>

                        <span>
                          <i class="fa-solid fa-location-dot"></i>
                          SMU Connexion, 40 Stamford Rd, Singapore 178908
                        </span>
                        
                        <div class="row text-muted my-4">
                          <div class="col-3">
                            <b>Age:</b> <br> 20
                          </div>
                          <div class="col-3">
                            <b>Gender:</b> <br> Male
                          </div>
                          <div class="col-3">
                            <b>Special Needs:</b> <br> No
                          </div>
                          <div class="col-3">
                            <b>Duration Required:</b> <br> 10 Months
                          </div>
                        </div>

                        <div class="row">
                          <button type="button" class="btn btn-tasklist mt-1" @click="openUpdate()">Update Last Seen</button>
                        </div>
                      </div>
                    </div>
                    <!-- End of Card Body -->
                  </div>
                </div>
              </div>
              <!-- End Of Card-->
             
            </div>
            </div>

            <!-- Right Side Portion (Samritan PIC + Name, Helped, Send Message, Update Last Seen)-->
            <div class="row">
              <div class="col-lg-9 col-sm-6">
                <!-- Start of Description and Paragraph-->
                <div class="listing-content col-lg-12 col-md-12 col-sm-12" style="font-family:'Raleway', Sans serif">
                  <h2>Description</h2>
                  <p style="padding-right:20%">
                    I have noticed that Mr Jeff So seems to loiter around SMU Connexion in the early hours. I have seen him on
                    several occasions when I reached school early to revise for my test. He use to sleep on the bench nearby
                    the
                    traffic junction. He is always seen with a white ripped t-shirt and pushing a trolley that full of junks.
                  </p>
                  
                </div>
              </div>

              <div class="col-lg-3 col-sm-6">

                <div class="card mb-3" id="referrer" >
                  <div class="row">
                    <div class="col-12">
                      <img src="Images/RkPorkhouse.jfif" class="img-fluid rounded-start">
                    </div>

                    <div class="col-12">
                      <div class="card-body" style= "font-size: 80%">
                        <h5 class="card-title" >Referrer: Lim Ren Kee</h5>
                        <p class="card-text">"Don't say why me, say try me."</p>
                        <p class="card-text"><small class="text-muted">Helped 3 people</small></p>
                        <div class="row">
                          <button type="button" class="btn btn-tasklist mt-1">Send Message</button>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
                


                <!-- Start Of Card -->
                <!-- <div class="card mb-3" id="referrer_card" style="border:transparent">
                  <div class="row" style="border:2px dotted;">

                   
                    <div class="col-4">
                      <img src="Images/RkPorkhouse.jfif" class="img-fluid rounded-start;"
                        style="height: auto; width: auto;">
                    </div>
                    
                    <div class="col-8">
                      <div class="card-body px-5" style="font-size: 80%;">
                        <div class="row d-flex" style="align-items:center">
                          <h5 class="card-title">Referrer: Lim Ren Kee</h5>
                          <p class="card-text my-1"><small class="text-muted">Helped 3 people</small></p>

                          <span>
                            "Don't say why me, say try me."

                          </span>
                        </div>

                        <div class="row">
                          <button type="button" class="btn btn-tasklist mt-1">Send Message</button>
                        </div>

                      </div>
                      
                    </div>           
                  </div>
                </div>
                
              </div> -->
            </div>
          <!-- End Of Row for left right portions-->

         
        </div>
        <!-- End Section for Listing Content -->

        <hr>

        <!-- Section for Map Listing-->

        <div class="listing-map">
          <!-- API Integration here-->
          <div id="mapListing"></div>
        </div>

        <hr>

        <div class="notes-content">
          <!-- Header -->
          <div class="row">
            <h2>Notes</h2>
          </div>

          <!-- First Two Notes -->
          <!-- First Note-->
          <div class="row mt-2">
            <!-- First Note-->
            <div class="card col-lg-5 mt-2">
              <div class="card-body">
                <h5 class="card-title">Waisoon's comment</h5>
                <p class="card-text">Some quick example text to build on the card title and make up the bulk of the
                  card's
                  content.</p>
              </div>
            </div>

            <!-- Separator -->
            <div class="col-2"></div>

            <!-- Second Note-->
            <div class="card col-lg-5 mt-2">
              <div class="card-body">
                <h5 class="card-title">Wenhai's comment</h5>
                <p class="card-text">Some quick example text to build on the card title and make up the bulk of the
                  card's
                  content.</p>
              </div>
            </div>
          </div>

          <div class="row mt-2">
            <!-- First Note-->
            <div class="card col-lg-5 mt-2">
              <div class="card-body">
                <h5 class="card-title">Jia Ler's comment</h5>
                <p class="card-text">Some quick example text to build on the card title and make up the bulk of the
                  card's
                  content.</p>
              </div>
            </div>

            <!-- Separator -->
            <div class="col-2"></div>

            <!-- Second Note-->
            <div class="card col-lg-5 mt-2">
              <div class="card-body">
                <h5 class="card-title">Ren Kee's comment</h5>
                <p class="card-text">Some quick example text to build on the card title and make up the bulk of the
                  card's
                  content.</p>
              </div>
            </div>
          </div>

        </div>
        <!-- End of Notes-content -->
      </div> <!-- End of Section -->
      <!-- End Of Container Section-->

    </div>


  </div>

  <div id="footerdiv">

    <footer-all></footer-all>

  </div>

  <!-- Refer to my own external JS -->
  <script src="common.js"></script>

  <script>
    // Vue instance
    const root = Vue.createApp({
      // Data Properties
      data() {
        return {
          mapUpdateMain: {},
          homeless_id: null,
          note_list: Array(), // list of lists [ [..], [..], [..] ]
          name: '',
          age: 0,
          gender: '', // F - female, M - male
          location: '', // string of location
          description: '',
          special_need_status: 0, // 0 - normal, 1 - special needs
          duration: 1 // num of months
        }
      },

      methods: {
        change_background_color(selected_color) {
          document.body.style.backgroundColor = selected_color
        },
        openUpdate() {
          let update = document.getElementById('update')
          let main = document.getElementById('main')
          update.classList.add('show-release')
          main.classList.add('blur')
        },
        closeUpdate() {
          let update = document.getElementById('update')
          let main = document.getElementById('main')
          update.classList.remove('show-release')
          main.classList.remove('blur')
        },
        retrieveHomelessLocation() {
          // api to retrieve location list by id
          // output list to dbLocationList
          let queryString = window.location.search
          let urlParams = new URLSearchParams(queryString)
          let id = urlParams.get('id')
          // console.log(id)
          let dbLocationList = Array()

          let api_endpoint_url = "https://roof-blanket.000webhostapp.com/roofBlanket_api/api/homeless/gethomelesslocationbyid.php?id=" + id

          axios.get(api_endpoint_url)
            .then(response => {
              let records = response.data.records // list of lists
              // console.log(records)
              for (row of records) {
                // console.log(row)
                let temp_location = [row.latitude, row.longitude]
                // console.log(temp_location)
                dbLocationList.push(temp_location)
              }
              console.log(dbLocationList)
            })
            .catch(error => {
              // In case of any error, see what it's about
              console.log(error.message)
            })
        },
        updateHomelessLocationToDb(mapUpdate) {
          // projectTest folder > mysqlSend.php for reference (wenhai)
          // try loop the object but if not able to, assume only 1 new location spotted input by user
          // redirect to php file with parameters added
          // "xxx.php" + ?id=${homeless_id}&latitude=${lat}&longitude=${lng}
        }
      },

      mounted() {
        // document.querySelector("#upload").addEventListener("change", (e) => {
        //   // console.log("upload ran")
        //   if (window.File && window.FileReader && window.FileList && window.Blob) {
        //     const files = e.target.files;
        //     const output = document.querySelector("#result");
        //     output.innerHTML = "";
        //     for (let i = 0; i < files.length; i++) {
        //       if (!files[i].type.match("image")) continue;
        //       const picReader = new FileReader();
        //       picReader.addEventListener("load", function (event) {
        //         const picFile = event.target;
        //         const div = document.createElement("div");
        //         div.innerHTML = `<img class="thumbnail mb-3" src="${picFile.result}" title="${picFile.name}"/>`;
        //         output.appendChild(div);
        //       });
        //       picReader.readAsDataURL(files[i]);
        //     }
        //   } else {
        //     alert("Your browser does not support File API");
        //   }
        // });

        // ****************************************************
        // Start of Map Script
        // KEEP MAP SCRIPT AS INTERNAL JS
        // DO NOT MOVE TO EXTERNAL JS
        // ****************************************************
        // mapListing portion
        let queryString = window.location.search
        let urlParams = new URLSearchParams(queryString)
        let id = urlParams.get('id')
        // console.log(id)
        this.homeless_id = id
        let dbLocationList = Array()

        let api_endpoint_url = "https://roof-blanket.000webhostapp.com/roofBlanket_api/api/homeless/gethomelesslocationbyid.php?id=" + id

        axios.get(api_endpoint_url)
          .then(response => {
            let records = response.data.records // list of lists
            // console.log(records)
            for (row of records) {
              // console.log(row)
              let temp_location = [parseFloat(row.latitude), parseFloat(row.longitude)]
              // console.log(temp_location)
              dbLocationList.push(temp_location)

              // retrieve note string from db here (not functional yet, require DB script to be updated first)
              // this.note_list.push(row.note) // TO-ADD v-for for note div html


            }

            /* another axios call to retrieve homeless information */
            let api_endpoint_url2 = "https://roof-blanket.000webhostapp.com/roofBlanket_api/api/homeless/gethomelessinfobyid.php?id=" + id

            axios.get(api_endpoint_url2)
              .then(response => {
                let records2 = response.data.records
                for (row of records2)
                {
                  // retrieve homeless info to display on html
                  this.name = row.name
                  this.age = row.age
                  this.gender = row.gender
                  this.location = row.location
                  this.description = row.description
                  this.special_need_status = row.special_needs
                  this.duration = row.duration
                }
              })
              .catch(error => {
                // In case of any error, see what it's about
                console.log(error.message)
              })
            /* END of second axios call */


            // console.log(dbLocationList)

            // dummy location for testing
            // let dbLocationList = [[35.66962384382411, 139.6430907463442], [35.66976330016642, 139.64738591458215], [35.66962384382411, 139.6600996125663]]
            getLocation();

            let currentLocation = dbLocationList[0]
            var mapListing = L.map('mapListing').setView(currentLocation, 13);
            L.marker(currentLocation).addTo(mapListing)

            L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png', {
              maxZoom: 19,
              attribution: '&copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>'
            }).addTo(mapListing);

            // add markers of all known homeless person location from location list
            for (index = 1; index < dbLocationList.length; index++) {
              // console.log(index, dbLocationList[index])
              L.marker(dbLocationList[index]).addTo(mapListing)
            }

            // mapUpdate portion
            var mapUpdate = {}
            var locationsList = [] // location list to update database; if > 1 markers, it will be List of Lists [ [..], [..], [..] ]

            // gets the location of the user and calls a method to add marker of user current location
            function getLocation() {
              if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(showPosition);
              }
              else {
                alert("Geolocation is not supported by this browser.")
              }
            }

            /* 
              add marker to show current location of the user
              add all markers of known locations of the homeless person
            */
            function showPosition(position) {
              let latitude = position.coords.latitude
              let longitude = position.coords.longitude

              mapUpdate = L.map('mapUpdate').setView([latitude, longitude], 13);
              L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png', {
                maxZoom: 19, attribution: '&copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>'
              }).addTo(mapUpdate);
              var marker = L.marker([latitude, longitude]).addTo(mapUpdate);
              // change marker of user current location to red
              marker._icon.classList.add("huechange");
              marker.bindPopup("<p style=color:red;>You are here</p>").openPopup();

              var popup = L.popup();

              // Script for adding marker on map click
              mapUpdate.on('click', onMapClick);

              // add markers of all known homeless person location from location list
              for (index = 0; index < dbLocationList.length; index++) {
                // console.log(index, dbLocationList[index])
                L.marker(dbLocationList[index]).addTo(mapUpdate)
              }
            }

            function onMapClick(e) {
              var geojsonFeature = {
                "type": "Feature",
                "properties": {},
                "geometry":
                {
                  "type": "Point",
                  "coordinates": [e.latlng.lat, e.latlng.lng]
                }
              }

              var marker;

              L.geoJson(geojsonFeature, {
                pointToLayer: function (feature, latlng) {
                  marker = L.marker(e.latlng, {
                    title: "Location",
                    alt: "Location",
                    riseOnHover: true,
                    // draggable: true,
                  }).bindPopup("<input type='button' value='Remove' class='marker-delete-button'/>");

                  marker.on("popupopen", onPopupOpen);
                  return marker;
                }
              }).addTo(mapUpdate);

              // add location to list
              let location = [e.latlng.lat, e.latlng.lng]
              // console.log(location)
              locationsList.push(location)
              // console.log(locationsList)
            }

            // Function to handle delete as well as other events on marker popup open
            function onPopupOpen() {
              var tempMarker = this;
              // console.log(tempMarker)
              // To remove marker on click of delete button in the popup of marker
              $(".marker-delete-button:visible").click(function () {
                mapUpdate.removeLayer(tempMarker);
                // remove from location list
                let lat = tempMarker["_latlng"].lat
                let long = tempMarker["_latlng"].lng
                let location = [lat, long]
                removeLatLng(location)
              });
            }

            // gets an array of latitude and longitude [x, y] and removes them from the location list array.
            function removeLatLng(location) {
              for (index in locationsList) {
                if (locationsList[index][0] == location[0] && locationsList[index][1] == location[1]) {
                  // remove from array using index
                  if (index > -1) {
                    locationsList.splice(index, 1)
                    console.log(locationsList)
                  }
                }
              }
            }
          })
          .catch(error => {
            // In case of any error, see what it's about
            console.log(error.message)
          })

      }
    });
    root.mount("#root")
    // ****************************************************
    // End of Map Script
    // ****************************************************
  </script>
</body>

<style>
  .update {
    background-color: #303C6C;
    border-radius: 10px;
    padding: 20px;
    position: absolute;
    color: #FBE8A6;
    visibility: hidden;
    width: 50%;
    left: 0;
    right: 0;
    z-index: 1;
  }

  .show-release {
    visibility: visible;
  }

  .blur {
    filter: blur(5px);
  }

  #result {
    padding: 10px 0;
    display: inline-flex;
  }

  .thumbnail {
    width: 100px;
    height: 100px;
    margin-right: 10px;
  }
</style>

</html>